;/*FB_PKG_DELIM*/

__d("WorkerBootstrap",["HasteSupportData","ServerJSDefine"],(function(a,b,c,d,e,f,g){"use strict";function h(a){Object.keys(a).forEach(function(b){c("ServerJSDefine").handleDefine(b,[],a[b],-1,null)})}function a(a,c){var f,g;a.hsdp&&d("HasteSupportData").handle(a.hsdp);var i=(f=(g=a.jsmods)!=null?g:a.dynamicModules)!=null?f:{};h(i);var j=b.call(null,c);a.rds!=null&&a.rds.length>0&&e.call(null,a.rds,function(){});if(typeof j==="function"||j!==null)try{for(var k=arguments.length,l=new Array(k>2?k-2:0),m=2;m<k;m++)l[m-2]=arguments[m];j.apply(void 0,l)}catch(a){}}function f(a){a=a;if(typeof a==="function"||a!==null)try{a()}catch(a){}}g.initDynamicModules=h;g.start=a;g.startServerJS=f}),98);
__d("CurrentSharedWorker",["HasteSupportData","QPLUserFlow","SharedWorkerStatusLock","WorkerBootstrap","emptyFunction","err","qpl","structuredClone"],(function(a,b,c,d,e,f,g){"use strict";var h=null,i=[],j=new Set(),k=[],l=!1,m=!1,n=null,o=!1,p=c("qpl")._(931609794,"2369");c("QPLUserFlow").start(p);var q=d("SharedWorkerStatusLock").getStatusLock({});c("QPLUserFlow").addPoint(p,"status_lock");c("QPLUserFlow").addAnnotations(p,{string:{id:self.worker_id}});self.setTimeout(function(){if(!o){try{var a;(a=j.values().next().value)==null?void 0:a.postMessage({type:"self-terminate",response:{from:"bundle",workerID:self.worker_id}})}catch(a){c("QPLUserFlow").endFailure(p,"timeout_termination_error"),x(a)}self.close()}},3e5);function r(){m=!0,n=null,h!==null&&(c("QPLUserFlow").addPoint(p,"process_message_buffer"),c("QPLUserFlow").addAnnotations(p,{"int":{message_buffer_size:i.length}}),i.forEach(function(a){return a()}),i=[]),c("QPLUserFlow").endSuccess(p)}function s(a,f){var g=a.data;if(typeof g==="object"&&(g==null?void 0:g.type)==="execute-worker"){var k=!l;try{if(!l&&g.args instanceof Array){var t=g.args[0],u=t.hsdp,v=t.jsmods,w=t.dynamicModules;t=t.rds;c("QPLUserFlow").addPoint(p,"first_init");u!=null&&d("HasteSupportData").handle(u);d("WorkerBootstrap").initDynamicModules((v=(u=v)!=null?u:w)!=null?v:{});t!=null&&t.length>0&&e.call(null,t,function(){});q.init();c("QPLUserFlow").addPoint(p,"status_lock_init");l=!0;n!=null&&(n(),r())}u=b.call(b,"SiteData");j.size>1&&f.postMessage({type:"execute-worker-imports",response:{}});f.postMessage({type:"execute-worker-ack",response:{firstInit:k,workerRevision:u.client_revision,spinMode:u.spin,spinTime:u.__spin_t}});o=!0}catch(a){c("QPLUserFlow").endFailure(p,"worker_init_error"),q.release(),f.postMessage({type:"execute-worker-ack",response:{firstInit:k,error:a.message}}),self.close()}}else if(typeof g==="object"&&(g==null?void 0:g.type)==="sw-get-rev")try{w=b.call(b,"SiteData");f.postMessage({type:"sw-get-rev",response:{workerRevision:w.client_revision,spinMode:w.spin,spinTime:w.__spin_t}})}catch(a){f.postMessage({type:"sw-get-rev",response:{error:a.message}})}else if(typeof g==="object"&&(g==null?void 0:g.type)==="sw-shutdown"){v=Array.isArray(g.args)?g.args[0]:null;typeof v==="object"&&(v==null?void 0:v.upgrade)===!0?y("requested-upgrade"):typeof v==="object"&&typeof (v==null?void 0:v.reason)==="string"?y(v==null?void 0:v.reason):y()}else if(typeof g==="object"&&(g==null?void 0:g.type)==="sw-uptime-tracking"){u=typeof (g==null?void 0:g.args)==="object"?(t=g.args)==null?void 0:t.trackerID:null;f.postMessage({type:"sw-uptime-tracking",response:{trackerID:u}})}else typeof g==="object"&&(g==null?void 0:g.type)==="ww-hrp-init"?f.postMessage({type:"ww-hrp-init",response:{}}):typeof g==="object"&&(g==null?void 0:g.type)==="ww-connection-ack"?f.postMessage({type:"connection-ack",response:{from:"bundle",workerID:self.worker_id}}):h!==null&&m?h(g):i.push(function(){return s(a,f)})}function a(a){var b=h==null;h=(a=a)!=null?a:c("emptyFunction");b&&m&&(i.forEach(function(a){return a()}),i=[])}function t(a,b){j.forEach(function(c){try{c.postMessage(a,b)}catch(b){c.postMessage(a)}})}function f(a){if(l){c("QPLUserFlow").addPoint(p,"init_complete_handler_ran");a();r();return}c("QPLUserFlow").addPoint(p,"init_complete_handler_attached");n=a}["log","error","info","debug","warn"].forEach(function(a){if(self.console[a]==null)throw c("err")('"'+a+'" is not a valid console method.');var b=self.console[a];self.console[a]=function(){for(var d=arguments.length,e=new Array(d),f=0;f<d;f++)e[f]=arguments[f];b.apply(void 0,e);var g=!1;try{c("structuredClone")!=null&&c("structuredClone")(e),g=!0}catch(a){}if(!g){t({type:"console",response:{method:"error",args:["DataCloneError: Failed to forward console message from web worker due to args not being serializable."]}});return}t({type:"console",response:{method:a,args:e}})}});try{c("QPLUserFlow").addPoint(p,"bootstrap_start");var u=self.shared_worker_bootstrap_buffer==null?void 0:self.shared_worker_bootstrap_buffer();if(u!=null){var v=u.ports,w=u.messages;c("QPLUserFlow").addAnnotations(p,{"int":{bootstrap_ports_num:v.length}});v==null?void 0:v.forEach(function(a){try{a.postMessage({type:"connection-ack",response:{from:"bundle",workerID:self.worker_id}}),a.addEventListener("message",function(b){return s(b,a)}),j.add(a)}catch(a){c("QPLUserFlow").addPoint(p,"connection_fail"),x(a)}});w==null?void 0:w.forEach(function(a){try{s(a.e,a.port)}catch(b){c("QPLUserFlow").addPoint(p,"message_processing_fail");c("QPLUserFlow").addAnnotations(p,{string:{failed_msg_type:(a=(a=a.e.data)==null?void 0:a.type)!=null?a:"unknown"}});x(b)}c("QPLUserFlow").addAnnotations(p,{"int":{msg_num:w.length},string_array:{msgs:w.map(function(a){return(a=a.e.data)==null?void 0:a.type})}})})}else c("QPLUserFlow").addPoint(p,"bootstrap_buffer_empty")}catch(a){x(a),c("QPLUserFlow").endFailure(p,"uncaught_bootstrap_error")}function x(a){try{t({type:"sw-uncaught-error",e:{message:a.message,lineno:a.lineno,colno:a.colno,filename:a.filename,error:a.error}})}catch(b){c("QPLUserFlow").addPoint(p,"sending_error_failed");c("QPLUserFlow").addAnnotations(p,{string:{error:String((a=b.message)!=null?a:b)}})}}self.addEventListener("error",function(a){if(j.size===0){k.push(a);return}x(a)});self.addEventListener("connect",function(a){var b=a.ports[0];b.postMessage({type:"connection-ack",response:{from:"bundle",workerID:self.worker_id}});b.addEventListener("message",function(a){return s(a,b)});b.start();j.add(b);k.length>0&&(k.forEach(x),k.splice(0,k.length))});function y(a){q.release(),t({type:"sw-shutdown",response:{reason:a,workerID:self.worker_id,isInitialized:o}}),self.close()}g.setMessageHandler=a;g.postMessage=t;g.onInitComplete=f;g.shutdownWorker=y}),98);
__d("CurrentSharedWorkerAdapter",["CurrentSharedWorker","FBLogger"],(function(a,b,c,d,e,f,g){a=function(){function a(){}var b=a.prototype;b.addEventListener=function(a,b,e){switch(a){case"message":d("CurrentSharedWorker").setMessageHandler(function(a){return b({data:a})});break;case"error":break;default:c("FBLogger")("worker").mustfix("Unexpected message type %",a)}};b.removeEventListener=function(a,b,e){switch(a){case"message":d("CurrentSharedWorker").setMessageHandler(null);break;case"error":break;default:c("FBLogger")("worker").mustfix("Unexpected message type %",a)}};b.postMessage=function(a,b){d("CurrentSharedWorker").postMessage(a,b)};return a}();g.CurrentSharedWorkerAdapter=a}),98);
__d("EncryptedBackupsMediaRestoreProbeQpl",["MAWQplProxy","WAGetPlatformFromStanzaId","justknobx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.isRetroactiveUpload,e=a.mediaType,f=a.msgType,g=a.probeDelayMs,h=a.restoreMethod,i=a.sampleRate,j=a.stanzaId;a=a.triggerSource;return d("MAWQplProxy").startQplUserFlow(c("qpl")._(521473213,"27"),{bool:{isRetroactiveUpload:b},"int":{probeDelayMs:g,sampleRate:i},string:{e2eePlatform:d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(j),mediaType:e,msgType:f,restoreMethod:h,triggerSource:a}},void 0,c("justknobx")._("3047"))}g.startMediaRestoreProbeQPLFlow=a}),98);
__d("EncryptedBackupsResignCdnUrl",["MAWBridge","MAWConfig","MAWLoggerUtils","WAJids","WAResolvable","WAResultOrError","asyncToGeneratorRuntime","cr:10071"],(function(a,b,c,d,e,f,g){"use strict";var h=new Map();function a(a){return h.get(a)}function c(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.deliveryObjectId,e=a.mediaType,f=a.msgId,g=a.protocolMsgId;a=a.sortOrderMs;if(b("cr:10071")!==null){var i=(yield b("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:g.chat,deliveryObjectId:c,externalId:g.externalId,mediaType:e,sortOrderMs:a}));return!i.success?i:d("WAResultOrError").makeResult(i.value)}else{i=d("MAWLoggerUtils").getInstanceKey();var j=new(d("WAResolvable").Resolvable)();h.set(i,j);d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ResignAttachmentCDNUrl",value:{deliveryObjectId:c,mediaType:e,messageId:g.externalId,msgId:f,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,skipLegacyMediaDownloadFlow:!0,sortOrder:a,threadId:d("WAJids").threadIdForChatJid(g.chat),threadJid:g.chat,traceId:i}}]});return j.promise}});return i.apply(this,arguments)}g.getRestoredCdnUrlResolvable=a;g.resignCdnUrl=c}),98);
__d("MAWGetMediaApi",["MAWDbMediaTxns","MAWDexieTable","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["cannot find xma with xmaId ",""]);h=function(){return a};return a}var i=function(a){var b=a.media;a=a.xmaMediaType;return b==null?null:{media:b,xmaMediaType:a}};b=d("MAWIndexedDb").makeMsgrTransactor({media:(a=d("MAWTransactionMode")).READONLY},"getMediaByPlaintextHash",function(a){return function(b){return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,b)}});c=d("MAWIndexedDb").makeMsgrTransactor({media:a.READONLY},"getMediaByMediaId",function(a){return function(b){return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b)}});e=d("MAWIndexedDb").makeMsgrTransactor({media:a.READONLY,xma:a.READONLY},"getMediaByXMAId",function(a){return function(b,c){return a.xma.get(b).then(function(e){if(e==null){c.ERROR(h(),b);return[]}return d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,e.defaultPreviewMediaId).then(function(a){return i({media:a,xmaMediaType:"preview"})}),d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,e.headerMediaId).then(function(a){return i({media:a,xmaMediaType:"headerImage"})}),d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,e.faviconMediaId).then(function(a){return i({media:a,xmaMediaType:"favicon"})})])})}});g.getMediaByPlaintextHash=b;g.getMediaByMediaId=c;g.getMediaByXMAId=e}),98);
__d("MAWGetMsgByProtocolIdApi",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY},"getMsgsByProtocolMsgIdsTxn",function(a){return function(b){return d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,b)}});g.getMsgsByProtocolMsgIdsTxn=a}),98);
__d("MAWDeletedMsgApi",["MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({deletedMessages:d("MAWTransactionMode").READONLY},"getDeletedMsgByProtocolIdApi",function(a){return function(b){return a.deletedMessages.get(babelHelpers["extends"]({},b))}});g.getDeletedMsgByProtocolIdApi=a}),98);
__d("MAWIsMsgDeletedWithReason",["MAWDbDeletedMessages","MAWDeletedMsgApi","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield d("MAWDeletedMsgApi").getDeletedMsgByProtocolIdApi(a));return!a?!1:a.reason===d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.ChatDelete||a.reason===d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke});return h.apply(this,arguments)}g.isMsgDeletedWithReason=a}),98);
__d("EncryptedBackupsMediaRestoreProbe",["EBUploadMediaPreview","EncryptedBackupsMediaRestoreProbeQpl","EncryptedBackupsResignCdnUrl","MAWCastToMsgrServerMediaType","MAWDbXMATxns","MAWGetMediaApi","MAWGetMsgByProtocolIdApi","MAWIndexedDb","MAWIsMsgDeletedWithReason","MAWMsgType","MAWTransactionMode","Promise","WAMediaUtils","WAPromiseDelays","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","cr:10071","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["restore media success for ",". mediaType: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["failed to restore media for ",". mediaType: ",", error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["unsupported media type ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["sortOrderMs is required for media restore, but not found for ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["skip restore probe because no attachment found"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["no dbMsg found for "," - msgType: "," - source: ",", retroactive: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["msg is deleted"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["start probe media backup through ",", is retroactive upload: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["cannot find media for xma with protocolMsgId ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["preview object id is null for recent thumbnail"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["preview object id is null and mediaKeyTimestamp is null"]);s=function(){return a};return a}var t=d("WATagsLogger").TAGS(["MediaRestoreProbe"]),u=c("justknobx")._("2045"),v=1713191110;function a(a){return w.apply(this,arguments)}function w(){w=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.isRetroactiveUpload,f=a.triggerSource;a=a.uploadEntity;switch(a.dbMsgType){case d("MAWMsgType").MSG_TYPE.REACTION:case d("MAWMsgType").MSG_TYPE.EDIT_ACTION:return d("WAResultOrError").makeResult("no-attachment-with-msg")}var g=E(),i=a.dbMsgType;i=C(i);i=Math.random()<g*i/100;if(!i)return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult("not-sampled"));var j=b("cr:10071")==null?"sproc":"gql";t.LOG(p(),j,e);yield d("WAPromiseDelays").delayMs(c("gkx")("2067")?5e3:u);var k=a.msgId;i=(yield d("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn([k]));var l=i[0];if(l==null){i=(yield d("MAWIsMsgDeletedWithReason").isMsgDeletedWithReason(k));if(i){t.LOG(o());return d("WAResultOrError").makeResult("msg-deleted")}t.ERROR(n(),k,a.dbMsgType,f,e);return d("WAResultOrError").makeError("missing-db-msg")}i=(yield A({dbMsg:l,protocolMsgId:k}));if(i.type==="no-attachment"){t.LOG(m());return d("WAResultOrError").makeResult("no-attachment-with-msg")}a=x(i,l.msgId);if(!a.success)return d("WAResultOrError").makeError([a.error]);i=a.value;a=(yield (h||(h=b("Promise"))).all(i.map(function(a){var b=d("EncryptedBackupsMediaRestoreProbeQpl").startMediaRestoreProbeQPLFlow({isRetroactiveUpload:e,mediaType:a.serverMediaType,msgType:l.type,probeDelayMs:u,restoreMethod:j,sampleRate:g,stanzaId:k.externalId,triggerSource:f});return y({dbMsg:l,payload:a,protocolMsgId:k}).then(function(a){if(a.success){b.endSuccess();return a}b.endFail(a.error,{string:{failReason:a.error}});return a})["catch"](function(a){b.endFail("runtime-error",{string:{failReason:a.toString()}});return d("WAResultOrError").makeError("runtime-error")})})));i=a.map(function(a){return a.success?null:a.error}).filter(Boolean);return i.length>0?d("WAResultOrError").makeError(i):d("WAResultOrError").makeResult("restore-media-success")});return w.apply(this,arguments)}function x(a,b){var c=[],e=a.type==="xma"?a.medias:[a];e.forEach(function(a){a=a.fullsize;a=a.mediaEntries.get(b);if(a==null)return d("WAResultOrError").makeError("missing-media-entry");a=d("WAMediaUtils").decodeMediaEntryData(a);var e=a.objectId;a=a.serverMediaType;c.push({objectId:e,serverMediaType:a})});a.type==="media-with-preview"&&(c.push({objectId:a.preview.objectId,serverMediaType:"preview"}),a.preview.objectId==null&&(a.preview.mediaKeyTimestamp==null?t.ERROR(s()):a.preview.mediaKeyTimestamp>v&&t.ERROR(r())));return d("WAResultOrError").makeResult(c)}function y(a){return z.apply(this,arguments)}function z(){z=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.dbMsg,c=a.payload;a=a.protocolMsgId;var e=b.msgId,f=b.sortOrderMs;if(f==null){t.ERROR(l(),a);return d("WAResultOrError").makeError("missing-sort-order-ms")}var g=c.objectId;c=c.serverMediaType;if(c==null||g==null)return d("WAResultOrError").makeError("invalid-media-entry");b=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(c,b.type===d("MAWMsgType").MSG_TYPE.XMA);if(b==null){t.ERROR(k(),c);return d("WAResultOrError").makeError("unsupported-media-type")}c=(yield d("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:g,mediaType:b,msgId:e,protocolMsgId:a,sortOrderMs:f}));if(!c.success){t.ERROR(j(),a,b,c.error);return c}t.LOG(i(),a,b);return d("WAResultOrError").makeResult("restore-media-success")});return z.apply(this,arguments)}function A(a){return B.apply(this,arguments)}function B(){B=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.dbMsg;a=a.protocolMsgId;switch(b.type){case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:if(b.plaintextHash==null)return{type:"no-attachment"};var c=(yield d("MAWGetMediaApi").getMediaByPlaintextHash(b.plaintextHash));if(d("EBUploadMediaPreview").getEnableEbUploadMediaPreview()&&c!=null){var e=c==null?void 0:c.mediaEntries.get(b.msgId);if(e!=null){e=d("WAMediaUtils").decodeMediaEntryData(e).downloadableThumbnail;if(e!=null&&e.objectId!=null)return{fullsize:c,preview:e,type:"media-with-preview"}}}return c==null?{type:"no-attachment"}:{fullsize:c,type:"media"};case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:if(b.plaintextHash==null)return{type:"no-attachment"};e=(yield d("MAWGetMediaApi").getMediaByPlaintextHash(b.plaintextHash));return e==null?{type:"no-attachment"}:{fullsize:e,type:"media"};case d("MAWMsgType").MSG_TYPE.RAVEN:case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:case d("MAWMsgType").MSG_TYPE.ADMIN:case d("MAWMsgType").MSG_TYPE.REVOKED:case d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return{type:"no-attachment"};default:b.type;c=(yield D(a));return c.length===0?{type:"no-attachment"}:{medias:c.map(function(a){return{fullsize:a}}),type:"xma"}}});return B.apply(this,arguments)}function C(a){switch(a){case d("MAWMsgType").MSG_TYPE.VIDEO:return 13;case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.PTT:return 8;case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case d("MAWMsgType").MSG_TYPE.XMA:return 20;default:return 1}}var D=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY},"getMediaByXMAId",function(a){return function(b){return d("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(a,b).then(function(a){if(!a.success){t.ERROR(q(),b);return[]}a=a.value;var c=a.defaultPreview,d=a.favicon,e=a.header;a=a.previews;return[c,d,e].concat(a==null?[]:a).filter(Boolean)})}});function E(){return c("gkx")("2067")?100:c("justknobx")._("2722")}g.sampleProbeMediaRestore=a}),98);
__d("MAWBuildNewMsgPayload",["MAWAuthor","MAWDbMsg","MAWMsgType","WAArmadilloXMA.pb","WAAssertUnreachable","WAJids","WALogger","WAStanzaUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["msgToQuotedMsg: Unsupported message type ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["BumpExistingMessage does not have quote content when replying"]);i=function(){return a};return a}function a(a,b,e,f){if(d("MAWDbMsg").isUnrenderedMsgType(a))throw c("err")("getNewMsg called for wrong message type "+a);var g,h;if(e.quote!=null&&(f==null?void 0:f.content)!=null){var i;h=f==null?void 0:(i=f.content)==null?void 0:i.externalId;g={content:f==null?void 0:f.content,remoteJid:(i=f==null?void 0:f.remoteJid)!=null?i:void 0}}f=babelHelpers["extends"]({},b,{quote:g,quoteExternalId:h});i=e.mediaGroupMetadata;switch(a){case"Text":return babelHelpers["extends"]({},f,{msgContent:{content:e.content!=null?e.content:"",mentionedJids:e.mentionedJids},type:d("MAWMsgType").MSG_TYPE.TEXT});case"Image":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.IMAGE},i);case"Video":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.VIDEO});case"Ptt":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.PTT});case"Gif":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.GIF});case"Sticker":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.STICKER});case"DocumentFile":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case"XMA":if(e.xmaMessageType==null)throw c("err")("XMA Message Missing xmaMessageType");b=e.content!=null&&e.xmaMessageType===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE?e.content:"";return babelHelpers["extends"]({},f,{msgContent:{content:b,mentionedJids:e.mentionedJids},type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:e.xmaMessageType});case"EditAction":throw c("err")("EditAction is not supported yet");case"BumpExistingMessage":throw c("err")("BumpExistingMessage is not supported yet");case"ReceiverFetch":throw c("err")("ReceiverFetch is not supported yet");case"GroupPollCreate":throw c("err")("GroupPollCreate is not supported yet");case"GroupPollUpdate":throw c("err")("GroupPollUpdate is not supported yet");case"Revoked":case"DeleteForMe":case"Ciphertext":case"Futureproof":case"Unavailable":case"Admin":case"ExpiredEphemeral":case"EphemeralSettingAdmin":case"EphemeralScreenshotAction":case"AlertICDC":case"GroupInvite":case"Reaction":case"Raven":case"RavenAction":throw c("err")("Should not be writing ciphertext, futureproof, unsent, admin,\n        ephemeral setting messages, ephemeral screenshot action, group invite messages");default:throw c("WAAssertUnreachable")(a)}}function b(a,b,e,f){if(!d("MAWDbMsg").isUnrenderedMsgType(a))throw c("err")("getNewUnrenderedMsg called for wrong message type "+a);switch(a){case"EphemeralSyncResponse":if(e.ephemeralSetting==null)throw c("err")("Ephemeral Sync Response without ephemeral settings");return babelHelpers["extends"]({},b,{ephemeralSetting:e.ephemeralSetting,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE});case"EphemeralSettingChangeFromCurrentDevice":var g;if(e.ephemeralSetting==null)throw c("err")("Ephemeral Setting Change without ephemeral settings");return babelHelpers["extends"]({},b,{ephemeralSetting:e.ephemeralSetting,isEphemeralSettingReset:(g=e.isEphemeralSettingReset)!=null?g:!1,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE});case"GroupInvite":g=d("WAJids").interpretAsGroupJid(b.threadJid);if(g==null)throw c("err")("Group Invite without valid group jid");if(e.invitedParticipantUserJid==null)throw c("err")("Group Invite without invited user jid");return babelHelpers["extends"]({},b,{groupName:e.groupName==null?void 0:e.groupName,invitedParticipantUserJid:e.invitedParticipantUserJid,type:d("MAWMsgType").MSG_TYPE.GROUP_INVITE});case"SenderKeyDistribution":return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION});case"RavenAction":if(f==null)throw c("err")("Raven Action without Raven Message External Id");if(e.actionType==null)throw c("err")("Raven Action without Action Type");return babelHelpers["extends"]({},b,{actionType:e.actionType,ravenActionToMsgExternalId:d("WAStanzaUtils").toStanzaId(f),type:d("MAWMsgType").MSG_TYPE.RAVEN_ACTION});case"EditAction":throw c("err")("Edit action not implemented yet");default:throw c("WAAssertUnreachable")(a)}}function e(a){var b,e={author:d("MAWAuthor").getAuthorUserJid(a.author)||d("WAJids").AUTHOR_ME,externalId:a.externalId,mediaId:a.mediaId,msgId:a.msgId,plaintextHash:a.plaintextHash,specialTextSize:a.specialTextSize,ts:a.ts,xmaMessageType:a.xmaMessageType};switch(a.type){case d("MAWMsgType").MSG_TYPE.IMAGE:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.IMAGE});case d("MAWMsgType").MSG_TYPE.VIDEO:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.VIDEO});case d("MAWMsgType").MSG_TYPE.PTT:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.PTT});case d("MAWMsgType").MSG_TYPE.TEXT:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.TEXT});case d("MAWMsgType").MSG_TYPE.STICKER:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.STICKER});case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case d("MAWMsgType").MSG_TYPE.GIF:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.GIF});case d("MAWMsgType").MSG_TYPE.XMA:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:a.xmaMessageType});case d("MAWMsgType").MSG_TYPE.REVOKED:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE});case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:if(((b=a.quote)==null?void 0:b.content)==null){d("WALogger").ERROR(i());return null}return babelHelpers["extends"]({},a.quote.content,{author:d("MAWAuthor").getAuthorUserJid(a.quote.content.author)||d("WAJids").AUTHOR_ME});case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH});case d("MAWMsgType").MSG_TYPE.RAVEN:return babelHelpers["extends"]({},e,{ravenEphemeralMediaState:a.ravenEphemeralMediaState,ravenEphemeralType:a.ravenEphemeralType,ravenMediaType:a.ravenMediaType,type:d("MAWMsgType").MSG_TYPE.RAVEN});default:d("WALogger").ERROR(h(),a.type);throw c("err")("Trying to reply to a message type that does not support replies")}}g.buildNewMsg=a;g.getNewUnrenderedMsg=b;g.msgToQuotedMsg=e}),98);
__d("MAWEBScheduler",["WorkerScheduler"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){h==null&&(h=d("WorkerScheduler").makeScheduler("eb",{concurrency:1,maxConcurrency:1,maxThrottleMs:1e3,timeToStuckMs:3e4}));return h}g.ebScheduler=a}),98);
__d("MAWEbUploadQueue",["EBEnableUnifiedAttachment","EBUnifyLegacyMediaUpload","EBUploadMessages","EncryptedBackupsMediaRestoreProbe","EncryptedBackupsUploadQueue","EncryptedBackupsUtils","MAWBridge","MAWBridgeUpload","MAWEBScheduler","MAWEBSwitch","MAWEBUploadTrackingUtils","MAWGetMsgByProtocolIdApi","WAGetSafeQPLError","WAGlobals","WAJids","WAPromiseBackoffs","WAShiftTimer","WAStanzaUtils","WATimeUtils","WAWaitForUserUnblocked","WorkerScheduler","asyncToGeneratorRuntime","gkx","justknobx","promiseDone","qex","setInterval"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpected runtime error in probeMediaRestore: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot get message from db: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue uploading "," messages"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose([""," cannot process EB upload"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg found 2"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg not found 1"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg found"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose([""," cannot process EB upload"]);o=function(){return a};return a}var p=d("EncryptedBackupsUploadQueue").logger.TAGS(["labyrinth-web"]),q=new Map(),r=new Map(),s=new Set(),t={algo:{first:c("justknobx")._("2366"),type:"exponential"},max:d("WATimeUtils").HOUR_MILLISECONDS},u=d("WAPromiseBackoffs").createTimer(t);a=u();c("setInterval")(e,1e3);var v=new(d("WAShiftTimer").ShiftTimer)(f),w=null;function x(){return y.apply(this,arguments)}function y(){y=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("WAWaitForUserUnblocked").waitForUserUnblocked();var e=!0;if(w!=null)return;w=d("MAWEBScheduler").ebScheduler().task({fn:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(c("MAWEBSwitch").isEnabled()){var a=(yield D());a=a.isEmpty;e=!a}else d("MAWEBUploadTrackingUtils").getUploadQueueStartedCache().forEach(function(a,b){d("MAWEBUploadTrackingUtils").removeExternalIdFromUploadQueueStartedCache(b)}),e=!1});function f(){return a.apply(this,arguments)}return f}(),name:"eb_upload",priority:d("WorkerScheduler").BACKGROUND_PRIORITY});w.run().then(function(){u=d("WAPromiseBackoffs").createTimer(t),a=u(),w=null,e&&void x()})["catch"](function(b){w=null,p.ERROR(k(),b),q.forEach(function(a,c,e){d("MAWEBUploadTrackingUtils").endFailWorkerOnly(c,"upload_eb_msgs_error",{string:{reason:d("WAGetSafeQPLError").getSafeQPLErrorMessage(b)}})}),q.clear(),e&&(a=u(),window.setTimeout(function(){void x()},c("justknobx")._("2366")+a))})});return y.apply(this,arguments)}function e(){var a=d("WATimeUtils").performanceAbsoluteNow();s.forEach(function(b){a-b>c("justknobx")._("2366")&&(s["delete"](b),c("promiseDone")(z()))});var b=[];for(var e of r){var f=e[0],g=e[1];s.has(g)||b.push(f)}b.forEach(function(a){return r["delete"](a)})}function f(){c("MAWEBSwitch").isEnabled()?void D()["catch"](function(a){p.ERROR(o(),a),q.forEach(function(b,c,e){d("MAWEBUploadTrackingUtils").endFailWorkerOnly(c,"upload_eb_msgs_error",{string:{reason:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}})}),q.clear(),v.onOrAfter(c("justknobx")._("2366"))}):(d("MAWEBUploadTrackingUtils").getUploadQueueStartedCache().forEach(function(a,b){d("MAWEBUploadTrackingUtils").removeExternalIdFromUploadQueueStartedCache(b)}),v.onOrAfter(c("justknobx")._("2366")))}function z(){return A.apply(this,arguments)}function A(){A=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(c("gkx")("5625")){c("promiseDone")(x());return}yield d("WAWaitForUserUnblocked").waitForUserUnblocked();v.onOrBefore(c("justknobx")._("2367"))});return A.apply(this,arguments)}function B(){c("MAWEBSwitch").onSet(function(){c("MAWEBSwitch").isEnabled()&&c("promiseDone")(z())});c("promiseDone")(z());var a=d("EncryptedBackupsUploadQueue").ebUploadQueue();a.subscribe(function(a){a.type==="flush"&&c("promiseDone")(z())})}function C(a){return d("MAWBridge").getBridge().sendAndReceive("event","uploadMessagesToBackup",{checkPoint:[],messages:a,qpl:[]})}function D(){return E.apply(this,arguments)}function E(){E=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=d("EncryptedBackupsUploadQueue").ebUploadQueue(),b=[],e=(yield a.read({filter:function(a){if(a.sortOrderMs==null||d("EncryptedBackupsUtils").entryOlderThan30Days(a.sortOrderMs)){b.push(a.queueId);return!1}else return!q.has(d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(a.msgId))},limit:c("justknobx")._("2368"),order:"desc"}));yield a["delete"](b);if(e.length===0)return{isEmpty:!0};p.LOG(j(),e.length);a=e.map(function(b){var c,e=d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(b.msgId),a=b.isRetroactiveUpload==null?!1:b.isRetroactiveUpload;return{bridgeUploadMessage:d("MAWBridgeUpload").createBridgeUploadMessage({actionType:b.backupActionType===3?2:1,attachmentContextArray:b.attachmentContext,echoDocument:void 0,echoEncodingLatencyNs:void 0,errorCode:void 0,errorMessage:void 0,messageId:((c=b.backupDirective)==null?void 0:c.supplementalKey)!=null?(c=b.backupDirective)==null?void 0:c.originalMsgProtocolId.externalId:b.msgId.externalId,protoMsg:{backupActionType:b.backupActionType,msgId:b.msgId,originalMsgProtocolId:(c=b.backupDirective)==null?void 0:c.originalMsgProtocolId,protobuf:b.protobuf,senderId:b.senderId,serverTs:b.serverTs,sortOrderMs:b.sortOrderMs,supplementalKey:b.supplementalKey},sortOrderMs:b.sortOrderMs||0,threadId:d("WAJids").threadIdForChatJid(b.msgId.chat),traceId:e.toString(),uploadTrackingInstanceKey:e}),isRetroactiveUpload:a,messageType:b.dbMsgType,queueId:b.queueId}});if(c("gkx")("8488")||c("qex")._("1682")===!0){for(var f of a){var g=f.bridgeUploadMessage,h=f.isRetroactiveUpload,k=f.messageType,l=f.queueId;q.set(parseInt(g.traceId,10),l);l=(l=g.protoMsg)==null?void 0:l.msgId;if(l!=null){l=d("MAWEBUploadTrackingUtils").getAndRemoveFromUploadQueueStartedCache(l.externalId)==null?"uploadqueue":I(d("WAGlobals").getMyUserJid()===l.author?d("WAJids").AUTHOR_ME:l.author);d("MAWEBUploadTrackingUtils").startUploadTracking(d("WAStanzaUtils").toStanzaId(g.messageId),k,l,parseInt(g.traceId,10),!0,h,(h=(k=g.attachmentBackupContext)==null?void 0:(l=k.attachmentInfos)==null?void 0:l.length)!=null?h:0)}}J(e.map(function(a){return a.legacyAttachmentContext}).filter(Boolean));yield C(a.map(function(a){a=a.bridgeUploadMessage;return a}));return{isEmpty:!1}}var m=new Map(),n=[],o=[],t=new Map(),u=new Map();for(g of e)if(g.originalMsgProtocolId.author!=null){k=g.originalMsgProtocolId.author;l=g.originalMsgProtocolId.chat;h={author:d("WAGlobals").getMyUserJid()===g.originalMsgProtocolId.author?d("WAJids").AUTHOR_ME:k,chat:l,externalId:g.backupActionType===4?g.msgId.externalId:g.originalMsgProtocolId.externalId};f=d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(g.msgId);q.set(f,g.queueId);t.set(h.externalId,(k=g.attachmentContext)!=null?k:o);l=g.msgId.externalId;k=g.originalMsgProtocolId.externalId;l!==k&&u.set(l,{currentExternalId:l,originalMsgExternalId:k});if(!m.has(h.externalId)){m.set(h.externalId,f);l=d("MAWEBUploadTrackingUtils").getAndRemoveFromUploadQueueStartedCache(g.msgId.externalId);k=l==null?"uploadqueue":I(h.author);d("MAWEBUploadTrackingUtils").startUploadTracking(h.externalId,l==null?void 0:l.msgType,k,f,!0,g.isRetroactiveUpload,(k=g==null?void 0:(l=g.attachmentContext)==null?void 0:l.length)!=null?k:0);n.push(h)}}else c("promiseDone")(d("EncryptedBackupsUploadQueue").ebUploadQueue().ack([g.queueId]));m.forEach(function(a,b){d("MAWEBUploadTrackingUtils").addPointWorkerOnly(a,"queue_get_original_msg_ids_done")});f=(yield d("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn(n)["catch"](function(a){n.forEach(function(b){b=m.get(b.externalId);b!=null?d("MAWEBUploadTrackingUtils").endFailWorkerOnly(b,"get_db_msgs_error",{string:{reason:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}}):p.WARN(i(),a)});throw a}));var w=d("WATimeUtils").performanceAbsoluteNow();s.add(w);var x=new Map();f.forEach(function(a){var b=m.get(a.externalId);if(b==null)return;r.set(b,w);d("MAWEBUploadTrackingUtils").addPointWorkerOnly(b,"queue_get_msgs_done");var c=u.get(a.externalId);c!=null&&d("MAWEBUploadTrackingUtils").addPointWorkerOnly(b,"external_id_mismatch",{string:{currentExternalId:c.currentExternalId,differing_ids_type:a.type,originalMsgExternalId:c.originalMsgExternalId}});x.set(a.externalId,(b=t.get(a.externalId))!=null?b:o)});H(m,n,f);J(e.map(function(a){return a.legacyAttachmentContext}).filter(Boolean));yield d("EBUploadMessages").uploadMessageFromUploadQueue(f,m,a.map(function(a){return a.bridgeUploadMessage.protoMsg}).filter(Boolean),x);c("gkx")("5625")||v.onOrBefore(c("justknobx")._("2366"));return{isEmpty:!1}});return E.apply(this,arguments)}function F(a,b){return G.apply(this,arguments)}function G(){G=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e=d("EncryptedBackupsUploadQueue").ebUploadQueue();b?d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(a,"upload_queue_ack_worker_success"):d("MAWEBUploadTrackingUtils").endFailWorkerOnly(a,"upload_queue_ack_worker_fail");var f=r.get(a);f!=null&&(r["delete"](a),s["delete"](f));var g=q.get(a);if(g==null)return;if(b){f=(yield e.read({filter:function(a){return a.queueId===g},limit:1}));b=f[0];if(b==null)return;void d("EncryptedBackupsMediaRestoreProbe").sampleProbeMediaRestore({isRetroactiveUpload:(f=b.isRetroactiveUpload)!=null?f:!1,triggerSource:I(b.msgId.author),uploadEntity:b})["catch"](function(a){p.ERROR(h(),a)})}yield e.ack([g]);q["delete"](a);c("promiseDone")(z())});return G.apply(this,arguments)}function H(a,c,e){if(c.length>e.length){var f=new Set(c.map(function(a){return a.externalId}));e.forEach(function(b){if(f.has(b.externalId)){f["delete"](b.externalId);var c=a.get(b.externalId);c!=null?d("MAWEBUploadTrackingUtils").addPointWorkerOnly(c,"msg_found",{string:{originalMsgType:b.type}}):p.WARN(n())}});f.forEach(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){b=a.get(b);if(b!=null){d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(b,"upload_queue_msg_not_found");var c=q.get(b);q["delete"](b);if(c==null)return;yield d("EncryptedBackupsUploadQueue").ebUploadQueue()["delete"]([c])}else p.WARN(m())});return function(a){return c.apply(this,arguments)}}())}else e.forEach(function(b){var c=a.get(b.externalId);c!=null?d("MAWEBUploadTrackingUtils").addPointWorkerOnly(c,"msg_found",{string:{originalMsgType:b.type}}):p.WARN(l())})}function I(a){return a===d("WAJids").AUTHOR_ME||a===d("WAGlobals").getMyUserJid()?"send":"receive"}function J(a){if(a.length===0)return;var b=[];a.forEach(function(a){a!=null&&a.forEach(function(a){b.push({tag:"UploadAttachment",value:a})})});b.length>0&&d("EBUnifyLegacyMediaUpload").getEnableUnifyLegacyMediaUpload()&&!d("EBEnableUnifiedAttachment").getEbEnableUnifiedAttachment()&&d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:b})}g.scheduleNextRun=z;g.listenForEbUploadQueueFlush=B;g.uploadEBMsgs=D;g.ackWithInstanceKey=F}),98);
__d("MAWLoadMsgsDedupper",["MAWDbMsgUtil","WAMsg"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a=new Set();return function(b){b=d("MAWDbMsgUtil").getProtocolMsgIdFromDbMsg(b);if(b==null)return!0;b=d("WAMsg").craftWAMsgIdString(b);if(b!=null){if(a.has(b))return!1;a.add(b)}return!0}}g["default"]=a}),98);
__d("MAWWriteOutgoingMsgApi",["MAWAckLevel","MAWBuildNewMsgPayload","MAWDbMsg","MAWDbMsgTxns","MAWDbRavenActionTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWQplProxy","MAWTransactionMode","MAWVault","MAWWriteMsgTxns","WAJids","WALogger","WATimeUtils","emptyFunction","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["writeOutgoingMsg: "," is not identical for partial optimistic upsert: "," vs ",""]);h=function(){return a};return a}var i=function(a,b,c,e){b!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c,a,{annotations:e,instanceKey:b})};function j(a,b,c){if(b===c)return;d("WALogger").WARN(h(),a,b,c)}b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ephemeralSettings:a.READWRITE,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,participants:a.READONLY,receiverFetchInfo:a.READONLY,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READONLY},"writeOutgoingMsg",function(a){return function(b,e,f,g,h,m,n){g.content!=null&&(g.content=d("MAWVault").vault(g.content));i("write_outgoing_msg_start",n,m);return d("MAWDexieTable").dexieAll([a.threads.get({jid:e}),a.messages.where("externalId").equals(b).toArray(),k(a,g.quote,e),d("MAWDbRavenActionTxns").maybeGetRavenMsgQueryByProtocolMsgId(a,g.ravenProtocolMsgId,h)]).then(function(e){var k=e[0],o=e[1],p=e[2];e=e[3];i("write_outgoing_msg_data_fetched",n,m,{bool:{isUnrenderedMsgType:d("MAWDbMsg").isUnrenderedMsgType(h)}});if(k==null)return{type:"missing_thread"};var q=o.find(function(a){return a.threadJid===k.jid&&a.author===d("WAJids").AUTHOR_ME});if(q!=null&&q.ack!==d("MAWAckLevel").ACK.partialOptimistic)return q.ack>=d("MAWAckLevel").ACK.sent?{msgId:q.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:k.jid,externalId:q.externalId},type:"already_sent"}:{msgId:q.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:k.jid,externalId:q.externalId},type:"not_sent"};else{var r=q==null?void 0:q.rowId;q&&(j("ts",q.ts,f),j("threadJid",q.threadJid,k.jid));if(!d("MAWDbMsg").isUnrenderedMsgType(h)){o={ack:d("MAWAckLevel").ACK.clock,altIndex:void 0,author:d("WAJids").AUTHOR_ME,ephemeralSetting:g.ephemeralSetting,externalId:b,isForwarded:g.isForwarded,specialTextSize:g.specialTextSize,threadJid:k.jid,ts:f};var s=d("MAWBuildNewMsgPayload").buildNewMsg(h,o,g,p),t=g.isFirstMsg,u=g.openMessageOtid,v=g.openMessageParticipantCount,w=g.optimisticMsg,x=g.participantCount;o=d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,s).then(function(b){return d("MAWWriteMsgTxns").writeMsg(a,s,k,"MAWWriteOutgoingMsgApi",{isCurrentDeviceSendingMsg:!0,isFirstMsg:t,isOutgoing:!0,openMessageOtid:u,openMessageParticipantCount:v,optimisticMsg:w,participantCount:x,quotedReplyAttachmentMeta:b,s2sInstanceKey:n,upsertRowData:r!=null?{msgId:c("nullthrows")(q==null?void 0:q.msgId),rowId:r}:void 0})})}else{p={ack:d("MAWAckLevel").ACK.clock,author:d("WAJids").AUTHOR_ME,externalId:b,threadJid:k.jid,ts:f};p=d("MAWBuildNewMsgPayload").getNewUnrenderedMsg(h,p,g,e==null?void 0:e.externalId);o=d("MAWWriteMsgTxns").writeUnrenderedMsg(a,p,k)}return o.then(function(c){i("write_outgoing_msg_promise_resolved",n,m);return l(a,h,k.jid,f).then(function(){return{msgId:c.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:k.jid,externalId:b},type:"not_sent"}})})}})}});function k(a,b,c){return b==null?d("MAWDexieTable").dexieResolve(null):d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(b){return b==null?null:a.threads.get({jid:b.threadJid}).then(function(a){var e=d("MAWBuildNewMsgPayload").msgToQuotedMsg(b);if(e==null)return null;b.messageExpirationTs!=null&&b.messageExpirationTs<d("WATimeUtils").unixTime()&&(e=babelHelpers["extends"]({},e,{mediaId:void 0,msgContent:void 0,type:d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL,xmaMessageType:void 0}));if(a==null||a.jid===c)return{content:e,remoteJid:null};a=d("WAJids").interpretAndValidateJid(a.jid);a=a.jidType==="group"?a.groupJid:null;return{content:e,remoteJid:a}})})}function l(a,b,e,f){if(b===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE)return d("WAJids").switchOnMsgrChatJidType(e,{group:function(){return d("MAWDexieTable").dexieResolve()},user:function(b){return a.ephemeralSettings.get({userJid:b}).then(function(b){var c;if(b==null)return d("MAWDexieTable").dexieResolve();b.ephemeralSyncResponseBackoffInfo={syncResponseRetries:((c=(c=b.ephemeralSyncResponseBackoffInfo)==null?void 0:c.syncResponseRetries)!=null?c:0)+1,syncResponseSentTs:f};return a.ephemeralSettings.put(b)}).then(c("emptyFunction"))}});return b===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE?d("WAJids").switchOnMsgrChatJidType(e,{group:function(){return d("MAWDexieTable").dexieResolve()},user:function(b){return a.ephemeralSettings.get({userJid:b}).then(function(b){if(b==null||b.ephemeralSyncResponseBackoffInfo==null)return d("MAWDexieTable").dexieResolve();b.ephemeralSyncResponseBackoffInfo=void 0;return a.ephemeralSettings.put(b).then(c("emptyFunction"))})}}):d("MAWDexieTable").dexieResolve()}g.writeOutgoingMsg=b;g.getQuoteInfo=k}),98);
__d("SharedWorkerBootstrap",["CurrentSharedWorker","CurrentSharedWorkerAdapter"],(function(a,b,c,d,e,f,g){"use strict";function a(a){h(function(){return b.call(null,a)})}function c(a){h(function(){return a})}function h(a){d("CurrentSharedWorker").onInitComplete(function(){var b=a();if(typeof b==="function"||b!==null)try{b(new(d("CurrentSharedWorkerAdapter").CurrentSharedWorkerAdapter)())}catch(a){}})}g.start=a;g.startServerJS=c}),98);
__d("SharedOrWebWorkerBootstrapInit",["SharedWorkerBootstrap","WorkerBootstrap"],(function(a,b,c,d,e,f){"use strict";function a(a){"SharedWorkerGlobalScope"in self&&self instanceof self.SharedWorkerGlobalScope?b("SharedWorkerBootstrap").startServerJS(a):b("WorkerBootstrap").startServerJS(a)}f.startServerJS=a}),66);
__d("WorkerBanzaiLazyQueueChannelWorker",["BanzaiLazyQueue","WorkerFuncChannel"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=d("WorkerFuncChannel").importChannel({queuePost:null},a,"banzai_lazyqueue_channel");c("BanzaiLazyQueue").onQueue.add(function(){h(b)});h(b)}function h(a){c("BanzaiLazyQueue").flushQueue().forEach(function(b){a.queuePost.apply(a,b)})}g.init=a}),98);
__d("WorkerSelf",["WorkerBanzaiLazyQueueChannelWorker","WorkerFuncChannel","WorkerQPLChannel"],(function(a,b,c,d,e,f,g){"use strict";function a(a){d("WorkerFuncChannel").activateChannels(a,"worker","client"),d("WorkerBanzaiLazyQueueChannelWorker").init(a),d("WorkerQPLChannel").setMessagePort(a)}g.init=a}),98);
__d("SharedWorker",["WorkerMessagePort","WorkerSelf"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=new(d("WorkerMessagePort").WorkerSyncedMessagePort)(a,"SharedWorker");d("WorkerSelf").init(b);b.addMessageListener("ping",function(a){b.postMessage({type:"pong"})})}g["default"]=a}),98);
__d("getProtocolMsgIdByMsgIdCommon",["MAWDexieTable","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return d("MAWDexieTable").dexieAll([a.messages.get({msgId:b}),a.unrenderedMessages.get({msgId:b}),a.reactions.get({reactionId:b})]).then(function(b){var c=b[0],e=b[1];b=b[2];if(b!=null)if(d("WAJids").isAuthorSystem(b.author))return null;else return{author:b.author,chat:b.threadJid,externalId:b.externalId};var f=c||e;return f==null?null:a.threads.get({jid:f.threadJid}).then(function(a){if(a==null)return null;return d("WAJids").isAuthorSystem(f.author)?null:{author:f.author,chat:a.jid,externalId:f.externalId}})})}g.getProtocolMsgIdByMsgIdCommon=a}),98);